apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aiteza-backend.fullname" . }}
  labels:
    {{- include "aiteza-backend.labels" . | nindent 4 }}
data:
  application.yaml: |-
    spring:
      security:
        oauth2:
          resourceserver:
            jwt:
              issuer-uri: {{ required "spring.security.oauth2.resourceserver.jwt.issuerUri is required!" .Values.spring.security.oauth2.resourceserver.jwt.issuerUri | quote }}
              audiences: {{ .Values.spring.security.oauth2.resourceserver.jwt.audiences | default "account" | quote }}
      ai:
        openai:
          base-url: {{ required "spring.ai.openai.baseUrl is required!" .Values.spring.ai.openai.baseUrl | quote }}
          chat:
            enabled: false
          embedding:
            enabled: true
            api-key: ${OPENAI_EMBEDDING_API_KEY}
            embeddings-path: {{ .Values.spring.ai.openai.embedding.embeddingsPath | default "/v1/embeddings" | quote }}
            options:
              dimensions: {{ .Values.spring.ai.openai.embedding.options.dimensions | default 768 }}
              model: {{ .Values.spring.ai.openai.embedding.options.model | default "nomic-embed-text:v1.5" | quote }}
              temperature: {{ .Values.spring.ai.openai.embedding.options.temperature | default 0.2 }}
      servlet:
        multipart:
          max-file-size: {{ .Values.spring.servlet.multipart.maxFileSize | default "400MB" | quote }}
          max-request-size: {{ .Values.spring.servlet.multipart.maxRequestSize | default "400MB" | quote }}

    server:
      port: {{ .Values.service.httpPort | default 80 }}
      compression:
        enabled: {{ .Values.server.compression.enabled | default true }}
        mime-types: {{ .Values.server.compression.mimeTypes | default "text/html,text/xml,text/plain,text/css,text/javascript,application/javascript,application/json" | quote }}
      tomcat:
        max-swallow-size: {{ .Values.server.tomcat.maxSwallowSize | default "100MB" | quote }}

    management:
      endpoints:
        web:
          exposure:
            include: info, health, prometheus
      endpoint:
        health:
          show-details: always
          probes:
            enabled: true
          group:
            deps:
              include: auth, s3, firecrawl, docling, reranking, embedding, llm, tika

    springdoc:
      swagger-ui:
        path: {{ .Values.springdoc.swaggerUi.path | default "/doc/swagger-ui.html" | quote }}
        disable-swagger-default-url: {{ .Values.springdoc.swaggerUi.disableSwaggerDefaultUrl | default true }}
        operationsSorter: {{ .Values.springdoc.swaggerUi.operationsSorter | default "alpha" | quote }}
        tagsSorter: {{ .Values.springdoc.swaggerUi.tagsSorter | default "alpha" | quote }}
        try-it-out-enabled: {{ .Values.springdoc.swaggerUi.tryItOutEnabled | default true }}
        oauth:
          client-id: {{ required "springdoc.swaggerUi.oauth.clientId is required!" .Values.springdoc.swaggerUi.oauth.clientId | quote }}

    s3:
      enabled: {{ .Values.s3.enabled | default false }}
{{- if .Values.s3.enabled }}
      endpoint: {{ required "s3.endpoint is required when s3.enabled is true" .Values.s3.endpoint | quote }}
      region: {{ required "s3.region is required when s3.enabled is true" .Values.s3.region | quote }}
      bucket-name: {{ required "s3.bucketName is required when s3.enabled is true" .Values.s3.bucketName | quote }}
      access-key: ${S3_ACCESS_KEY}
      secret-key: ${S3_SECRET_KEY}
{{- end }}

    aiteza:
      files:
        chat-file-expiration-days: {{ .Values.aiteza.files.chatFileExpirationDays | default 7 }}
        cleanup-schedule: {{ .Values.aiteza.files.cleanupSchedule | default "0 0 2 * * *" | quote }}
        cleanup-batch-size: {{ .Values.aiteza.files.cleanupBatchSize | default 10 }}
      audit:
        enabled: {{ .Values.aiteza.audit.enabled | default true }}
{{- if .Values.aiteza.audit.enabled }}
        loki-url: {{ required "aiteza.audit.lokiUrl is required!" .Values.aiteza.audit.lokiUrl | quote }}
        job-label: {{ .Values.aiteza.audit.jobLabel | default "aiteza-audit" | quote }}
        connection-timeout: {{ .Values.aiteza.audit.connectionTimeout | default 5000 }}
        read-timeout: {{ .Values.aiteza.audit.readTimeout | default 5000 }}
{{- if .Values.aiteza.audit.secretRef.name }}
        username: ${LOKI_USERNAME}
        password: ${LOKI_PASSWORD}
{{- end }}
{{- end }}
      litellm:
        url: {{ required "aiteza.litellm.url is required!" .Values.aiteza.litellm.url | quote }}
      security:
        public-paths:
{{- range .Values.aiteza.security.publicPaths }}
          - {{ . | quote }}
{{- end }}
        frontend-origin: {{ required "aiteza.frontendOrigin is required!" .Values.aiteza.frontendOrigin | quote }}
      database:
        connection-pool:
          min-idle: {{ .Values.aiteza.database.connectionPool.minIdle | default 5 }}
          max: {{ .Values.aiteza.database.connectionPool.max | default 90 }}
          idle-timeout: {{ .Values.aiteza.database.connectionPool.idleTimeout | default 5000 }}
        postgres:
          host: {{ required "aiteza.database.postgres.host is required!" .Values.aiteza.database.postgres.host | quote }}
          port: {{ .Values.aiteza.database.postgres.port | default 5432 }}
          login: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: {{ .Values.aiteza.database.postgres.database | default "aiteza" | quote }}
          schema: {{ .Values.aiteza.database.postgres.schema | default "public" | quote }}
      keycloak:
        authServerUrl: {{ required "aiteza.keycloak.authServerUrl is required!" .Values.aiteza.keycloak.authServerUrl | quote }}
        realm: {{ required "aiteza.keycloak.realm is required!" .Values.aiteza.keycloak.realm | quote }}
        frontend-client-id: {{ required "aiteza.keycloak.frontendClientId is required!" .Values.aiteza.keycloak.frontendClientId | quote }}
        backend-client-id: {{ required "aiteza.keycloak.backendClientId is required!" .Values.aiteza.keycloak.backendClientId | quote }}
        backend-client-secret: ${KEYCLOAK_BACKEND_CLIENT_SECRET}
        n8n-client-id: {{ required "aiteza.keycloak.n8nClientId is required!" .Values.aiteza.keycloak.n8nClientId | quote }}
        n8n-client-secret: ${KEYCLOAK_N8N_CLIENT_SECRET}
        admin-username: ${KEYCLOAK_ADMIN_USERNAME}
        admin-password: ${KEYCLOAK_ADMIN_PASSWORD}
      etl:
        tika:
          endpoint: {{ required "aiteza.etl.tika.endpoint is required!" .Values.aiteza.etl.tika.endpoint | quote }}
        docling:
          enabled: {{ .Values.aiteza.etl.docling.enabled | default true }}
{{- if .Values.aiteza.etl.docling.enabled }}
          base-url: {{ required "aiteza.etl.docling.baseUrl is required!" .Values.aiteza.etl.docling.baseUrl | quote }}
          convert-endpoint: {{ .Values.aiteza.etl.docling.convertEndpoint | default "/v1/convert/file" | quote }}
          convert-async-endpoint: {{ .Values.aiteza.etl.docling.convertAsyncEndpoint | default "/v1/convert/source/async" | quote }}
          result-endpoint: {{ .Values.aiteza.etl.docling.resultEndpoint | default "/v1/result" | quote }}
          status-endpoint: {{ .Values.aiteza.etl.docling.statusEndpoint | default "/v1/status/poll" | quote }}
          max-polling-attempts: {{ .Values.aiteza.etl.docling.maxPollingAttempts | default 2160 }}
          polling-interval-in-seconds: {{ .Values.aiteza.etl.docling.pollingIntervalInSeconds | default 10 }}
          do-ocr: {{ .Values.aiteza.etl.docling.doOcr | default true }}
          force-ocr: {{ .Values.aiteza.etl.docling.forceOcr | default false }}
          ocr-engine: {{ .Values.aiteza.etl.docling.ocrEngine | default "easyocr" | quote }}
          pdf-backend: {{ .Values.aiteza.etl.docling.pdfBackend | default "dlparse_v4" | quote }}
          table-mode: {{ .Values.aiteza.etl.docling.tableMode | default "accurate" | quote }}
          image-export-mode: {{ .Values.aiteza.etl.docling.imageExportMode | default "placeholder" | quote }}
          abort-on-error: {{ .Values.aiteza.etl.docling.abortOnError | default false }}
          return-as-file: {{ .Values.aiteza.etl.docling.returnAsFile | default false }}
          do-table-structure: {{ .Values.aiteza.etl.docling.doTableStructure | default true }}
          include-images: {{ .Values.aiteza.etl.docling.includeImages | default true }}
          images-scale: {{ .Values.aiteza.etl.docling.imagesScale | default 2 }}
          do-code-enrichment: {{ .Values.aiteza.etl.docling.doCodeEnrichment | default false }}
          do-formula-enrichment: {{ .Values.aiteza.etl.docling.doFormulaEnrichment | default false }}
          do-picture-classification: {{ .Values.aiteza.etl.docling.doPictureClassification | default false }}
          do-picture-description: {{ .Values.aiteza.etl.docling.doPictureDescription | default false }}
          from-formats: {{ .Values.aiteza.etl.docling.fromFormats | default (list "docx" "pptx" "html" "image" "pdf" "md" "csv" "xlsx" "audio") | toJson }}
          vlm-pipeline-options:
{{- if .Values.aiteza.etl.docling.vlmPipelineOptions.headers }}
{{- if gt (len .Values.aiteza.etl.docling.vlmPipelineOptions.headers) 0 }}
            headers: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.headers | toJson }}
{{- end }}
{{- end }}
{{- if .Values.aiteza.etl.docling.vlmPipelineOptions.params }}
{{- if gt (len .Values.aiteza.etl.docling.vlmPipelineOptions.params) 0 }}
            params: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.params | toJson }}
{{- end }}
{{- end }}
            response-format: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.responseFormat | quote }}
            concurrency: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.concurrency | default 4 }}
            timeout: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.timeout | default 240 }}
            scale: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.scale | default "2.0" | quote }}
            temperature: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.temperature | default "0.4" | quote }}
{{- end }}
        firecrawl:
          max-subpages: {{ .Values.aiteza.etl.firecrawl.maxSubpages | default 200 }}
          max-depth: {{ .Values.aiteza.etl.firecrawl.maxDepth | default 3 }}
          endpoint: {{ .Values.aiteza.etl.firecrawl.endpoint | default "https://api.firecrawl.dev" | quote }}
          api-key: ${FIRECRAWL_API_KEY}
          search:
            num-results: {{ .Values.aiteza.etl.firecrawl.search.numResults | default 5 }}
            timeout-in-seconds: {{ .Values.aiteza.etl.firecrawl.search.timeoutInSeconds | default 90 }}
      search:
{{- if .Values.aiteza.search.reranking }}
        reranking:
          enabled: {{ .Values.aiteza.search.reranking.enabled | default false }}
          endpoint: {{ .Values.aiteza.search.reranking.endpoint | quote }}
          model: {{ .Values.aiteza.search.reranking.model | quote }}
          api-key: ${RERANKING_API_KEY}
          threshold: {{ .Values.aiteza.search.reranking.threshold | default 0.1 }}
{{- end }}
{{- if .Values.aiteza.search.reprompting }}
        reprompting:
          enabled: {{ .Values.aiteza.search.reprompting.enabled | default true }}
          model: {{ .Values.aiteza.search.reprompting.model | quote }}
          query-count: {{ .Values.aiteza.search.reprompting.queryCount | default 3 }}
{{- end }}
{{- if .Values.aiteza.search.fileNameSearch }}
        file-name-search:
          enabled: {{ .Values.aiteza.search.fileNameSearch.enabled | default true }}
          model: {{ .Values.aiteza.search.fileNameSearch.model | quote }}
{{- end }}
        vector-threshold: {{ .Values.aiteza.search.vectorThreshold | default 0.3 }}
        full-text-weight: {{ .Values.aiteza.search.fullTextWeight | default 0.7 }}
        initial-fetch-size: {{ .Values.aiteza.search.initialFetchSize | default 50 }}
        per-dataroom-top-k: {{ .Values.aiteza.search.perDataroomTopK | default 10 }}
      chatNameModel: {{ required "aiteza.chatNameModel is required!" .Values.aiteza.chatNameModel | quote }}
      repromptModel: {{ required "aiteza.repromptModel is required!" .Values.aiteza.repromptModel | quote }}
      imageDescriptionModel: {{ required "aiteza.imageDescriptionModel is required!" .Values.aiteza.imageDescriptionModel | quote }}
      hallucination-detection-model: {{ .Values.aiteza.hallucinationDetectionModel | quote }}
      models:
        health:
          timeoutSeconds: {{ .Values.aiteza.models.health.timeoutSeconds | default 20 }}
{{- $models := required "aiteza.models is required!" .Values.aiteza.models }}
{{- range $modelName, $model := $models }}
{{- if ne $modelName "health" }}
        {{ $modelName }}:
          model: {{ $model.model | quote }}
          name: {{ $model.name | quote }}
          description: {{ $model.description | quote }}
          default-model: {{ $model.defaultModel | default false }}
          enabled: {{ $model.enabled | default false }}
{{- if hasKey $model "replacedBy" }}
          replacedBy: {{ $model.replacedBy }}
{{- end }}
{{- if hasKey $model "selectable" }}
          selectable: {{ $model.selectable }}
{{- end }}
          multi-modal: {{ $model.multiModal | default false }}
          icon: {{ $model.icon | quote }}
          type: {{ $model.type | quote }}
          endpoint: {{ $model.endpoint | quote }}
{{- if $model.externalHostname }}
          external-hostname: {{ $model.externalHostname | quote }}
{{- end }}
{{- if $model.reasoningEffort }}
          reasoning-effort: {{ $model.reasoningEffort | quote }}
{{- end }}
{{- if hasKey $model "vlmPipeline" }}
          vlm-pipeline: {{ $model.vlmPipeline }}
{{- end }}
          chunks: {{ $model.chunks | default 20 }}
          api-key: ${AITEZA_{{ upper $modelName | replace "-" "_" }}_API_KEY}
{{- if $model.options }}
          options:
{{ $model.options | toYaml | indent 12 }}
{{- end }}
{{- if $model.capabilities }}
          capabilities:
{{ $model.capabilities | toYaml | indent 12 }}
{{- end }}
{{- end }}
{{- end }}
