apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "aiteza-backend.fullname" . }}
  labels:
    {{- include "aiteza-backend.labels" . | nindent 4 }}
data:
  application.yaml: |-
    spring:
      security:
        oauth2:
          resourceserver:
            jwt:
              issuer-uri: {{ required "spring.security.oauth2.resourceserver.jwt.issuerUri is required!" .Values.spring.security.oauth2.resourceserver.jwt.issuerUri | quote }}
              audiences: {{ .Values.spring.security.oauth2.resourceserver.jwt.audiences | default "account" | quote }}
      ai:
        openai:
          base-url: {{ required "spring.ai.openai.baseUrl is required!" .Values.spring.ai.openai.baseUrl | quote }}
          chat:
            enabled: false
          embedding:
            enabled: true
            options:
              model: "nomic-embed-text:v1.5"
              temperature: 0.2

    server:
      port: {{ .Values.service.httpPort | default 80 }}

    management:
      endpoints:
        web:
          exposure:
            include: info, health, prometheus
      endpoint:
        health:
          show-details: always
          probes:
            enabled: true
          group:
            deps:
              include: auth, s3, firecrawl, docling, reranking, embedding, llm, tika

    springdoc:
      swagger-ui:
        oauth:
          client-id: {{ required "springdoc.swaggerUi.oauth.clientId is required!" .Values.springdoc.swaggerUi.oauth.clientId | quote }}

    s3:
      enabled: {{ .Values.s3.enabled | default false }}
{{- if .Values.s3.enabled }}
      endpoint: {{ required "s3.endpoint is required when s3.enabled is true" .Values.s3.endpoint | quote }}
      region: {{ required "s3.region is required when s3.enabled is true" .Values.s3.region | quote }}
      bucket-name: {{ required "s3.bucketName is required when s3.enabled is true" .Values.s3.bucketName | quote }}
      access-key: ${S3_ACCESS_KEY}
      secret-key: ${S3_SECRET_KEY}
{{- end }}

    aiteza:
      audit:
        enabled: {{ .Values.aiteza.audit.enabled | default true }}
{{- if .Values.aiteza.audit.enabled }}
        loki-url: {{ required "aiteza.audit.lokiUrl is required!" .Values.aiteza.audit.lokiUrl | quote }}
        job-label: {{ .Values.aiteza.audit.jobLabel | default "aiteza-audit" | quote }}
        connection-timeout: {{ .Values.aiteza.audit.connectionTimeout | default 5000 }}
        read-timeout: {{ .Values.aiteza.audit.readTimeout | default 5000 }}
{{- if .Values.aiteza.audit.secretRef.name }}
        username: ${LOKI_USERNAME}
        password: ${LOKI_PASSWORD}
{{- end }}
{{- end }}
      litellm:
        url: {{ required "aiteza.litellm.url is required!" .Values.aiteza.litellm.url | quote }}
      security:
        public-paths:
          - "/v3/api-docs/**"
          - "/doc/**"
          - "/actuator/**"
          - "/v1/**"
      frontend-origin: {{ required "aiteza.frontendOrigin is required!" .Values.aiteza.frontendOrigin | quote }}
      schedule:
        websource-cleaner: "0 0/5 * * * *"
      database:
        connection-pool:
          min-idle: {{ .Values.aiteza.database.connectionPool.minIdle | default 5 }}
          max: {{ .Values.aiteza.database.connectionPool.max | default 90 }}
          idle-timeout: {{ .Values.aiteza.database.connectionPool.idleTimeout | default 5000 }}
        postgres:
          host: {{ required "aiteza.database.postgres.host is required!" .Values.aiteza.database.postgres.host | quote }}
          port: {{ .Values.aiteza.database.postgres.port | default 5432 }}
          login: ${POSTGRES_USER}
          password: ${POSTGRES_PASSWORD}
          database: {{ .Values.aiteza.database.postgres.database | default "aiteza" | quote }}
          schema: {{ .Values.aiteza.database.postgres.schema | default "public" | quote }}
      keycloak:
        authServerUrl: {{ required "aiteza.keycloak.authServerUrl is required!" .Values.aiteza.keycloak.authServerUrl | quote }}
        realm: {{ required "aiteza.keycloak.realm is required!" .Values.aiteza.keycloak.realm | quote }}
        clientId: {{ required "aiteza.keycloak.clientId is required!" .Values.aiteza.keycloak.clientId | quote }}
        adminUsername: ${KEYCLOAK_ADMIN_USERNAME}
        adminPassword: ${KEYCLOAK_ADMIN_PASSWORD}
      etl:
        tika:
          endpoint: {{ required "aiteza.etl.tika.endpoint is required!" .Values.aiteza.etl.tika.endpoint | quote }}
        docling:
          enabled: {{ .Values.aiteza.etl.docling.enabled | default true }}
{{- if .Values.aiteza.etl.docling.enabled }}
          base-url: {{ required "aiteza.etl.docling.baseUrl is required!" .Values.aiteza.etl.docling.baseUrl | quote }}
          convert-endpoint: {{ .Values.aiteza.etl.docling.convertEndpoint | default "/v1/convert/file" | quote }}
          convert-async-endpoint: {{ .Values.aiteza.etl.docling.convertAsyncEndpoint | default "/v1/convert/source/async" | quote }}
          result-endpoint: {{ .Values.aiteza.etl.docling.resultEndpoint | default "/v1/result" | quote }}
          status-endpoint: {{ .Values.aiteza.etl.docling.statusEndpoint | default "/v1/status/poll" | quote }}
          do-ocr: {{ .Values.aiteza.etl.docling.doOcr | default true }}
          ocr-engine: {{ .Values.aiteza.etl.docling.ocrEngine | default "easyocr" | quote }}
          pdf-backend: {{ .Values.aiteza.etl.docling.pdfBackend | default "dlparse_v4" | quote }}
          table-mode: {{ .Values.aiteza.etl.docling.tableMode | default "accurate" | quote }}
          from-formats: {{ .Values.aiteza.etl.docling.fromFormats | default (list "docx" "pptx" "html" "image" "pdf" "md" "csv" "xlsx" "audio") | toJson }}
          vlm-pipeline-options:
            concurrency: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.concurrency | default 4 }}
            timeout: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.timeout | default 240 }}
            scale: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.scale | default "2.0" | quote }}
            temperature: {{ .Values.aiteza.etl.docling.vlmPipelineOptions.temperature | default "0.4" | quote }}
{{- end }}
        firecrawl:
          max-subpages: {{ .Values.aiteza.etl.firecrawl.maxSubpages | default 200 }}
          max-depth: {{ .Values.aiteza.etl.firecrawl.maxDepth | default 3 }}
          endpoint: {{ .Values.aiteza.etl.firecrawl.endpoint | default "https://api.firecrawl.dev" | quote }}
          api-key: ${FIRECRAWL_API_KEY}
          search:
            num-results: {{ .Values.aiteza.etl.firecrawl.search.numResults | default 5 }}
            timeout-in-seconds: {{ .Values.aiteza.etl.firecrawl.search.timeoutInSeconds | default 90 }}
      search:
        reranking:
          enabled: {{ .Values.aiteza.search.reranking.enabled | default false }}
{{- if .Values.aiteza.search.reranking.enabled }}
          endpoint: {{ .Values.aiteza.search.reranking.endpoint | quote }}
          model: {{ .Values.aiteza.search.reranking.model | quote }}
          api-key: ${RERANKING_API_KEY}
{{- end }}
        full-text-weight: {{ required "aiteza.search.fullTextWeight is required!" .Values.aiteza.search.fullTextWeight }}
      chatNameModel: {{ required "aiteza.chatNameModel is required!" .Values.aiteza.chatNameModel | quote }}
      repromptModel: {{ required "aiteza.repromptModel is required!" .Values.aiteza.repromptModel | quote }}
      models:
        health:
          timeoutSeconds: 5
{{- $models := required "aiteza.models is required!" .Values.aiteza.models }}
{{- range $modelName, $model := $models }}
        {{ $modelName }}:
          model: {{ $model.model | quote }}
          name: {{ $model.name | quote }}
          description: {{ $model.description | quote }}
          default-model: {{ $model.defaultModel | default false }}
          enabled: {{ $model.enabled | default false }}
          selectable: {{ if hasKey $model "selectable" }}{{ $model.selectable }}{{ else }}true{{ end }}
          multi-modal: {{ $model.multiModal | default false }}
          icon: {{ $model.icon | quote }}
          type: {{ $model.type | quote }}
          endpoint: {{ $model.endpoint | quote }}
          chunks: {{ $model.chunks | default 20 }}
          api-key: ${AITEZA_{{ upper $modelName | replace "-" "_" }}_API_KEY}
{{- if $model.options }}
          options:
{{ toYaml $model.options | indent 12 }}
{{- end }}
{{- end }}
